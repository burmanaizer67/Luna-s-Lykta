<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Luna's Lykta</title>
  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --accent: #7cf7c6;
      --accent2: #8ab4ff;
      --warm: #ffd36a;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius: 22px;
      --font: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --fs: 18px;
      --page-ar: 2 / 3;
      --veil: 0;
      --glow: 1;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(138,180,255,.35), transparent 55%),
        radial-gradient(1000px 700px at 80% 30%, rgba(124,247,198,.22), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(255,255,255,.12), transparent 60%),
        var(--bg);
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px;
      position:relative;
      overflow-x:hidden;
      padding-top:40px;
      padding-bottom:40px;
    }

    .app{
      width:min(900px, 100%);
      display:none;
      grid-template-columns: 1fr;
      gap:16px;
      position:relative;
      z-index:2;
      margin: 0 auto 16px;
    }
    
    .app.visible{
      display: grid;
    }

    .card{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      padding:28px;
      aspect-ratio: var(--page-ar);
      display:flex;
      flex-direction:column;
    }

    .storyContent{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .chapterMedia{
      border-radius: calc(var(--radius) - 6px);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      padding:18px;
      display:flex;
      align-items:flex-start;
      position:relative;
      overflow:hidden;
      aspect-ratio: var(--page-ar);
      box-shadow: 0 14px 30px rgba(0,0,0,.25);
    }

    .chapterMedia.hasImage{
      background-image: var(--chapter-image);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      background-color: rgba(0,0,0,.08);
    }

    .chapterMedia.hasImage.whiteBands{
      background-color: #fff;
      background-image:
        linear-gradient(180deg, #fff 0 12%, rgba(255,255,255,0) 12% 88%, #fff 88% 100%),
        var(--chapter-image);
      background-size: 100% 100%, contain;
      background-repeat: no-repeat, no-repeat;
      background-position: center, center;
    }

    .chapterMedia:not(.hasImage){
      aspect-ratio: auto;
      padding:0;
      border:none;
      box-shadow:none;
      background: transparent;
    }

    .chapterOverlay{
      width:min(70%, 520px);
      padding:14px 16px;
      background: transparent;
      border: none;
      border-radius: 0;
      backdrop-filter: none;
    }

    .chapterMedia.hasImage .chapterOverlay{
      position:absolute;
      top:16px;
      left:16px;
    }

    .chapterMedia.hasImage.whiteBands .chapterOverlay{
      top:6px;
      left:8px;
      right:8px;
      width:auto;
      text-align:center;
      color:#0b1020;
      text-shadow:none;
    }

    .chapterMedia.hasImage.whiteBands .text{
      color:#0b1020;
      text-shadow:none;
    }

    .chapterMedia.tightLines .text{
      line-height: 1.15;
    }

    .chapterMedia.hasImage .chapterOverlay.right{
      left:auto;
      right:0;
      width: min(55%, 420px);
      text-align: right;
    }

    .chapterBottom{
      position:absolute;
      left:16px;
      bottom:16px;
      width:min(70%, 520px);
      white-space: pre-wrap;
    }

    .chapterMedia.hasImage.whiteBands .chapterBottom{
      left:8px;
      right:8px;
      bottom:6px;
      width:auto;
      text-align:center;
      color:#0b1020;
      text-shadow:none;
    }

    .chapterMedia.tightLines .chapterBottom{
      line-height: 1.15;
    }

    .chapterMedia.hasImage .text{
      color: rgba(255,255,255,.95);
    }

    .chapterMedia:not(.hasImage) .chapterOverlay{
      width:auto;
      padding:0;
      background: transparent;
      border: none;
      border-radius: 0;
      backdrop-filter: none;
      position: static;
    }

    .chapterMedia:not(.hasImage) .chapterBottom{
      position: static;
      width:auto;
      display:none;
    }

    .coverPage{
      width:min(900px, 100%);
      margin:0 auto 16px;
      display: block;
    }
    
    .coverPage.hidden{
      display: none;
    }

    .coverFrame{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      padding:28px;
      aspect-ratio: var(--page-ar);
      position:relative;
      background-color: rgba(0,0,0,.12);
    }

    .coverImg{
      width:100%;
      height:100%;
      object-fit: contain;
      object-position: center;
      border-radius: calc(var(--radius) - 6px);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 30px rgba(0,0,0,.25);
      display:block;
    }

    .coverOverlay{
      position:absolute;
      inset: auto 18px 18px 18px;
      padding:12px 14px 14px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.55));
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
    }

    .coverTitle{
      font-size: 30px;
      margin:0 0 6px;
      letter-spacing:.3px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .coverSubtitle{
      font-size: 14px;
      color: var(--muted);
      margin:0 0 12px;
      font-weight: 400;
    }

    @media (max-width: 600px){
      :root{
        --fs: 16px;
        --page-ar: auto;
      }
      
      body{
        padding: 12px;
        padding-top: 20px;
        padding-bottom: 20px;
      }
      
      .app{
        gap: 12px;
        margin-bottom: 12px;
      }
      
      .card{ 
        padding: 16px;
        aspect-ratio: auto;
        display: flex;
        flex-direction: column;
      }
      
      .storyContent{
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .coverPage{
        margin-bottom: 12px;
      }
      
      .coverFrame{ 
        padding: 12px;
        aspect-ratio: auto;
      }
      
      .coverImg{
        max-height: 400px;
        border-radius: calc(var(--radius) - 4px);
      }
      
      .coverTitle{ 
        font-size: 24px;
      }
      
      .coverSubtitle{
        font-size: 13px;
      }
      
      .coverOverlay{ 
        inset: auto 10px 10px 10px;
        padding: 10px 12px;
      }
      
      h1, .story-title, .titleInImage {
        font-size: 22px;
        margin-bottom: 12px;
      }
      
      .subtitle{
        font-size: 13px;
        margin-bottom: 12px;
      }
      
      .chapterMedia{
        border-radius: calc(var(--radius) - 4px);
        padding: 0;
        aspect-ratio: auto;
        min-height: 250px;
        background-size: contain !important;
        background-position: center !important;
        border: none;
        box-shadow: none;
      }
      
      .chapterMedia.hasImage{
        min-height: 280px;
      }
      
      .chapterOverlay{
        position: static !important;
        padding: 0 !important;
        width: 100% !important;
        max-width: none;
        background: transparent !important;
        border: none !important;
        backdrop-filter: none !important;
        display: none;
      }
      
      .chapterOverlay.right{
        width: 100%;
        text-align: left;
      }
      
      .chapterBottom{
        position: static !important;
        width: 100% !important;
        max-width: none;
        left: auto !important;
        right: auto !important;
        bottom: auto !important;
        padding: 16px 0 0 0 !important;
        margin-top: 12px;
        color: rgba(255,255,255,.92) !important;
        text-shadow: none !important;
      }
      
      .chapterMedia.hasImage .chapterOverlay{
        display: none;
      }
      
      .chapterMedia.hasImage.whiteBands .chapterOverlay{
        display: none;
      }
      
      .chapterMedia.hasImage.whiteBands .chapterBottom{
        color: rgba(255,255,255,.92) !important;
        text-shadow: none !important;
      }
      
      .text{
        font-size: 16px;
        line-height: 1.75;
        margin-bottom: 16px;
      }
    }

    h1{
      font-size: 28px;
      margin:0 0 20px;
      letter-spacing:.2px;
    }

    .story-title{
      font-size: 32px;
      margin:0 0 10px;
      letter-spacing:.3px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .titleInImage{
      font-size: 22px;
      margin: 0 0 10px;
      letter-spacing: .2px;
      font-weight: 700;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 8px rgba(0,0,0,.55);
    }

    .chapterMedia.tightLines .titleInImage{
      margin-bottom: 18px;
    }

    .chapterMedia.hasImage.whiteBands .titleInImage{
      color:#0b1020;
      text-shadow:none;
    }

    .subtitle{
      font-size: 14px;
      color: var(--muted);
      margin:0 0 16px;
      font-weight: 400;
    }

    .text{
      font-size: var(--fs);
      line-height: 1.8;
      color: rgba(255,255,255,.92);
      margin:0 0 24px;
      white-space: pre-wrap;
    }

    .language-switcher{
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      gap: 8px;
      background: rgba(0,0,0,.2);
      backdrop-filter: blur(10px);
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
    }

    .language-switcher a{
      color: rgba(255,255,255,.7);
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all .2s ease;
      cursor: pointer;
    }

    .language-switcher a:hover{
      color: rgba(255,255,255,.95);
      background: rgba(255,255,255,.08);
    }

    .language-switcher a.active{
      color: var(--accent);
      background: rgba(124,247,198,.15);
      border: 1px solid rgba(124,247,198,.3);
    }

    @media (max-width: 600px){
      .language-switcher{
        top: 8px;
        right: 8px;
        padding: 6px 10px;
      }

      .language-switcher a{
        font-size: 12px;
        padding: 3px 6px;
      }
    }

    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .coverPage {
        display: none;
      }
      
      .app {
        gap: 0;
        margin: 0;
      }
      
      .card, .coverFrame {
        background: white;
        border: none;
        box-shadow: none;
        backdrop-filter: none;
        padding: 0;
        page-break-after: always;
        break-after: page;
      }
      
      .storyContent {
        gap: 0;
      }
      
      h1, .story-title, .titleInImage {
        color: #000;
        text-shadow: none;
        background: none;
        -webkit-background-clip: unset;
        -webkit-text-fill-color: unset;
        background-clip: unset;
      }
      
      .text, .subtitle {
        color: #000;
        text-shadow: none;
      }
      
      .chapterMedia {
        border: none;
        background: white;
        box-shadow: none;
        padding: 0;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      .chapterMedia.hasImage {
        background-color: white;
      }
      
      .chapterMedia.hasImage.whiteBands {
        background-color: white;
        background-image: none;
      }
      
      .chapterOverlay {
        background: transparent;
        border: none;
        backdrop-filter: none;
      }
      
      .chapterMedia.hasImage .chapterOverlay {
        position: static;
        backdrop-filter: none;
      }
      
      .chapterBottom {
        position: static;
        color: #000;
        text-shadow: none;
      }
    }
  </style>
</head>

<body>
  <div class="language-switcher">
    <a href="index.html">SV</a>
    <a href="index-en.html" class="active">EN</a>
  </div>

  <section class="coverPage" aria-label="Cover">
    <div class="coverFrame">
      <img class="coverImg" src="LunasBilder/Luna'sLantern.png" alt="Cover: Luna's Lantern" />
      <div class="coverOverlay">
        <h1 class="coverTitle">Luna's Lantern</h1>
        <p class="coverSubtitle">A Tale of Courage</p>
      </div>
    </div>
  </section>

  <div class="app" id="story">
    <div class="card">
      <div class="storyContent">
        <h1 id="title">Chapter 1</h1>
        <div class="chapterMedia" id="chapterMedia">
          <div class="chapterOverlay" id="chapterOverlay">
            <div class="text" id="text"></div>
          </div>
          <div class="text chapterBottom" id="chapterBottom"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const chapters = [
      {
        title: "",
        image: "LunasBilder/Lyktan.png",
        bottomLines: 4,
        text: `One evening when Noah looked up at the moon, he saw something blinking in the garden.
In the grass stood a small lantern.
He crept quietly out and picked it up - and then
heard a soft voice:
"Noah - I am Luna,
guardian of the night's paths.
I make sure starlight finds the right way
so that everyone can feel safe in the dark."
The lantern glowed warmly.
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
"But now the paths' light has gone out...
and I need your help to light them again."
The lantern shimmered.
"You are chosen because you have a brave heart.
You see things that others sometimes miss - and you dare to take small steps forward."
Noah held the lantern carefully.

The adventure had begun.`
      },
      {
        title: "",
        image: "LunasBilder/Stigar.png",
        text: `The lantern began to glow brighter in Noah's hands.

A soft, golden light spread - and suddenly a shimmering map appeared floating in the air before him.

Small paths wound through forests, over water, and through gentle mist.

It felt like something exciting was about to begin.

"Follow the light," whispered Luna.

"You will find three sparks of courage - small lights that have lost their way."

Noah looked closely at the map.

His heart beat faster - not from fear, but from anticipation.

"What happens when I find them?" he asked softly.

"Then the night's paths will be lit again," Luna answered warmly.

"And more will find safety in the dark."

Noah took a deep breath.

He stood before a great adventure - and the world was waiting for him.

The lantern blinked softly - ready to show the way.

He smiled a little.

The adventure had truly begun.`
      },
      {
        title: "",
        image: "LunasBilder/TheAdventureBegins.png",
        titleInImage: true,
        text: ``
      },
      {
        title: "",
        image: "LunasBilder/TheWhisperingForest.png",
        titleInImage: true,
        text: ``
      },
      {
        title: "",
        image: "LunasBilder/NattsÃ¶k.png",
        titleInImage: true,
        bottomLines: 3,
        text: `Noah followed the map's gentle light until he stood at the edge of a forest. The trees rose tall and still, and it sounded as if the leaves whispered secrets to each other.

Sam walked close by his side, sniffed the air, and gently wagged his tail - as if he could also feel that something magical waited inside. A narrow path wound between the trunks.

Noah paused for a moment. "I think we should go this way," he whispered. Sam took a step first, as if to show the way. Noah smiled and followed.

With every step they took, the lantern shone a little brighter and cast soft shadows on the ground. The forest felt kind, but also full of secrets - as if it were listening.

Noah drew a calm breath. "We are on the right path," he said softly. Sam walked safely beside him.

Together they continued through the whispering forest, deeper into the night's adventure.`
      },
      {
        title: "",
        image: "LunasBilder/Stigfinnarna.png",
        titleInImage: true,
        text: ``
      },
      {
        title: "",
        image: "LunasBilder/FÃ¶rstaGnistan.png",
        titleInImage: true,
        text: `The path led Noah and Sam to a mirror-still lake.

The water lay completely still, as if it slept beneath the night's stars.

On the surface, round stones rose - like a path across to the other side.

Out over the lake floated a soft, golden light.

Noah stopped and looked.

"Is it... a spark?" he whispered.

"Yes," Luna answered softly.
"The first spark of courage is waiting for you."

It tingled in his stomach.

"We can do it, Sam," said Noah.

Sam wagged his tail and walked close beside him.

Noah put his foot on the first stone.

It was steady.

Then the next.

And the next.

The lantern shone a little brighter with each step.

When they reached the middle, Noah carefully held out his hand.

The spark trembled like a tiny heartbeat - and then flew softly into the lantern.

A warm glow spread over the lake.

Small ripples danced out across the water.

Noah grinned.

"We did it."

Sam gave a happy bark.

The adventure continued.`
      },
      {
        title: "",
        image: "LunasBilder/TheStillLake.png",
        titleInImage: true,
        text: ``
      },
      {
        title: "Misty Valley",
        image: "LunasBilder/Dimman.png",
        titleInImage: true,
        tightLines: true,
        titleGap: 30,
        text: `
The path led Noah and Sam onward until the ground was covered in soft, shimmering mist.

It glimmered faintly in the lantern's light - as if little stars had hidden there.

Soon Noah could only see a few steps ahead. He stopped.

"I don't really know where we're going," he whispered.

Sam lifted his nose and sniffed gently in the air.

Then he took a calm step forward - and looked back at Noah, as if to say: follow me.


Noah smiled a little and went after him.

The lantern glowed warmly in his hands.

"Follow the light and trust the path," whispered Luna.

The mist moved softly around them, opening small corridors that vanished behind their steps.


It felt as if the forest held its breath.

Suddenly something began to shimmer farther ahead - a golden light hovering still.

"A spark," whispered Noah. Sam stopped beside him.

Noah walked forward and carefully held out his hand. The spark flew softly into the lantern.


The light grew brighter - and the mist glowed faintly before it slowly lifted.

Noah felt calm and strong. "Good job, Sam," he said softly.


Sam wagged his tail happily.

Together they continued through the night's adventure.`
      },
      {
        title: "",
        image: "LunasBilder/TheMistyValley.png",
        titleInImage: true,
        text: ``
      },
      {
        title: "Guardian of the Night",
        image: "LunasBilder/StarryNight.png",
        titleInImage: true,
        text: `The path led Noah and Sam up to an open place where the sky felt closer than ever.

The stars glittered brightly above them.

In the middle of the ground stood an arch of soft starlight - like a gate not yet open.

Before it sat a large, still owl with silver-shimmering feathers.

"Welcome, Noah," said the owl in a calm voice.
"I am the guardian of the night's path."

Noah felt his heart beat a little faster, but Sam stood safely by his side.

"You have come far," the guardian continued.
"But the last spark shows itself only to one who dares to believe in his own light."

Noah looked around.

It was still.

"How do I do it?" he whispered.

The owl blinked slowly.

"Stand still. Breathe. And listen."

Noah took a deep breath.

The lantern began to glow - first faintly, then stronger.

Suddenly a soft golden light lit up before him, as if it came from the air itself.

The last spark drifted forward.

Noah carefully held out his hand.

The spark swirled gently and flew into the lantern.

The light became clear and warm - stronger than before.

The owl nodded.

"You carry the courage within you."

The star gate began to shimmer.

The adventure was ready for its final step.`
      },
      {
        title: "",
        image: "LunasBilder/GuardianOfTheNight.png",
        titleInImage: true,
        text: ``
      },
      {
        title: "",
        image: "LunasBilder/Porten.png",
        titleInImage: true,
        text: ``
      },
      {
        title: "The Star Gate Opens",
        image: "LunasBilder/Natten.png",
        titleInImage: true,
        text: `The star gate began to shine brighter, as if it awakened.

The three sparks in the lantern glowed warm and clear.

Noah held it carefully before him.

"You are ready," Luna whispered softly.

Noah took a step forward - with Sam close by his side.

As the lantern drew near the gate, the light flowed out into the air like golden rays.

The gate opened slowly.

Behind it spread a sea of starlight that moved softly like a still breeze.

The sparks lifted out of the lantern and drifted up toward the sky.

One by one they flew away - and lit the night's paths again.

Forests, lakes, and valleys filled with a warm glow.

It felt as if the whole world smiled.

Noah stood still and felt his heart fill with something big and calm at the same time.

"You did it," said Luna.

"You dared - even when you did not know exactly how."

Sam sat beside him and leaned gently against his leg.

Noah petted him and smiled.

"We did it together."

The light around them grew softer.

The star gate closed slowly, as if it knew everything was in balance again.`
      },
      {
        title: "",
        image: "LunasBilder/Hemma.png",
        titleInImage: true,
        text: ``
      },
      {
        title: "ðŸŒ™ Epilogue â€” Home Again",
        image: "LunasBilder/Tillbaka.png",
        titleInImage: true,
        text: `When Noah opened his eyes, he was back in his room.

The lantern rested quietly on the nightstand and glowed faintly - as if it smiled.

Sam lay curled up beside the bed and slept peacefully.

Noah slipped under the blanket.

He now knew that the night's paths were lit again - thanks to his courage.

Even when he himself had felt a little afraid, he kept moving forward.

And somewhere out there, children who had been afraid of the dark could now feel safer, because the night light was back.

Noah pulled the blanket a little closer to his chin and smiled.

He felt safe.

Not because everything was always easy -

but because he knew that courage lived within him.

And that he was never alone.

Outside, the stars blinked softly, as if they whispered:

"Thank you."`
      },
      {
        title: "",
        image: "LunasBilder/FallowYourHeart.png",
        titleInImage: true,
        text: ``
      }
    ];

    const el = (id) => document.getElementById(id);
    const title = el("title");
    const text = el("text");
    const chapterMedia = el("chapterMedia");
    const chapterOverlay = el("chapterOverlay");
    const chapterBottom = el("chapterBottom");
    const storyContent = document.querySelector(".storyContent");
    const swipeSurface = document.querySelector("#story .card");
    const coverPage = document.querySelector(".coverPage");
    const appSection = document.querySelector("#story");

    let idx = 0;
    let lastSwipeAt = 0;
    let pointerStartX = 0;
    let pointerStartY = 0;
    let pointerActive = false;
    let storyStarted = false;

    const SWIPE_THRESHOLD = 60;
    const SWIPE_COOLDOWN = 450;
    
    function startStory(){
      if(storyStarted) return;
      storyStarted = true;
      coverPage.classList.add("hidden");
      appSection.classList.add("visible");
      render();
    }

    function stopSpeak(){
      if("speechSynthesis" in window){
        window.speechSynthesis.cancel();
      }
    }

    function speakCurrent(){
      stopSpeak();
      if(!("speechSynthesis" in window)) {
        alert("Speech synthesis is not supported in this browser.");
        return;
      }
      const c = chapters[idx];
      const utter = new SpeechSynthesisUtterance(c.title + ". " + c.text);
      utter.lang = "en-US";
      utter.rate = 0.75;
      utter.pitch = 0.95;
      utter.volume = 1.0;
      
      const voices = window.speechSynthesis.getVoices();
      const englishVoice = voices.find(v => v.lang.startsWith("en")) || voices[0];
      if(englishVoice) utter.voice = englishVoice;
      
      window.speechSynthesis.speak(utter);
    }

    function goNext(){
      if(idx === chapters.length - 1) return;
      stopSpeak();
      idx++;
      render();
    }

    function goPrev(){
      if(idx === 0) return;
      stopSpeak();
      idx--;
      render();
    }

    function render(){
      const c = chapters[idx];
      chapterOverlay.classList.toggle("right", c.overlay === "right");
      title.textContent = c.title;
      if(c.titleInImage && c.image){
        if(!chapterOverlay.contains(title)){
          chapterOverlay.insertBefore(title, text);
        }
        title.classList.add("titleInImage");
        title.style.marginBottom = c.titleGap ? `${c.titleGap}px` : "";
      } else {
        if(!storyContent.contains(title)){
          storyContent.insertBefore(title, chapterMedia);
        }
        title.classList.remove("titleInImage");
        title.style.marginBottom = "";
      }
      if(c.topText && c.bottomText){
        text.textContent = c.topText;
        chapterBottom.textContent = c.bottomText;
        chapterBottom.style.display = "block";
      } else if(c.image && c.bottomLines){
        const lines = c.text.split("\n");
        const nonEmptyIdx = lines
          .map((line, i) => (line.trim() ? i : -1))
          .filter(i => i !== -1);
        const lastN = nonEmptyIdx.slice(-c.bottomLines);
        const bottomText = lastN.map(i => lines[i]).join("\n");
        lastN.forEach(i => { lines[i] = ""; });
        const topText = lines.join("\n").trim();
        text.textContent = topText;
        chapterBottom.textContent = bottomText;
        if(c.bottomBold){
          chapterBottom.innerHTML = "";
          const strong = document.createElement("strong");
          strong.textContent = bottomText;
          chapterBottom.appendChild(strong);
        }
        chapterBottom.style.display = "block";
      } else if(c.image && idx === 0){
        const lines = c.text.split("\n");
        const nonEmptyIdx = lines
          .map((line, i) => (line.trim() ? i : -1))
          .filter(i => i !== -1);
        const lastTwo = nonEmptyIdx.slice(-2);
        const bottomText = lastTwo.map(i => lines[i]).join("\n");
        lastTwo.forEach(i => { lines[i] = ""; });
        const topText = lines.join("\n").trim();
        text.textContent = topText;
        chapterBottom.textContent = bottomText;
        chapterBottom.style.display = "block";
      } else {
        text.textContent = c.text;
        chapterBottom.textContent = "";
        chapterBottom.style.display = "none";
      }
      if(c.image){
        chapterMedia.style.setProperty("--chapter-image", `url(${c.image})`);
        chapterMedia.classList.add("hasImage");
        chapterMedia.classList.toggle("whiteBands", c.whiteBands === true);
        chapterMedia.classList.toggle("tightLines", c.tightLines === true);
      } else {
        chapterMedia.style.removeProperty("--chapter-image");
        chapterMedia.classList.remove("hasImage");
        chapterMedia.classList.remove("whiteBands");
        chapterMedia.classList.remove("tightLines");
      }
    }

    window.addEventListener("keydown", (e)=>{
      if(e.key === "ArrowLeft") goPrev();
      if(e.key === "ArrowRight") goNext();
      if(e.key.toLowerCase() === "l") speakCurrent();
      if(e.key.toLowerCase() === "s") stopSpeak();
    });

    swipeSurface.addEventListener("wheel", (e)=>{
      const now = Date.now();
      if(now - lastSwipeAt < SWIPE_COOLDOWN) return;
      if(Math.abs(e.deltaX) <= Math.abs(e.deltaY)) return;
      if(Math.abs(e.deltaX) < 40) return;
      e.preventDefault();
      lastSwipeAt = now;
      if(e.deltaX > 0){
        goNext();
      } else {
        goPrev();
      }
    }, { passive: false });

    swipeSurface.addEventListener("pointerdown", (e)=>{
      pointerActive = true;
      pointerStartX = e.clientX;
      pointerStartY = e.clientY;
      swipeSurface.setPointerCapture(e.pointerId);
    });

    swipeSurface.addEventListener("pointermove", (e)=>{
      if(!pointerActive) return;
      const dx = e.clientX - pointerStartX;
      const dy = e.clientY - pointerStartY;
      if(Math.abs(dx) < SWIPE_THRESHOLD) return;
      if(Math.abs(dx) <= Math.abs(dy)) return;
      pointerActive = false;
      swipeSurface.releasePointerCapture(e.pointerId);
      if(dx < 0){
        goNext();
      } else {
        goPrev();
      }
    });

    swipeSurface.addEventListener("pointerup", ()=>{ pointerActive = false; });
    swipeSurface.addEventListener("pointercancel", ()=>{ pointerActive = false; });

    swipeSurface.addEventListener("click", (e) => {
      if(!storyStarted) return;
      const rect = swipeSurface.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const halfWidth = rect.width / 2;
      
      if(clickX < halfWidth){
        goPrev();
      } else {
        goNext();
      }
    });
    
    let touchStartX = 0;
    let touchStartY = 0;
    let isSwiping = false;
    
    swipeSurface.addEventListener("touchstart", (e) => {
      if(!storyStarted) return;
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isSwiping = false;
    });
    
    swipeSurface.addEventListener("touchmove", (e) => {
      if(!storyStarted) return;
      const touchCurrentX = e.touches[0].clientX;
      const touchCurrentY = e.touches[0].clientY;
      const diffX = Math.abs(touchCurrentX - touchStartX);
      const diffY = Math.abs(touchCurrentY - touchStartY);
      
      if(diffX > diffY && diffX > 30){
        isSwiping = true;
        e.preventDefault();
      }
    }, { passive: false });
    
    swipeSurface.addEventListener("touchend", (e) => {
      if(!storyStarted) return;
      const touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;
      
      if(isSwiping && Math.abs(diff) > 50){
        if(diff > 0){
          goNext();
        } else {
          goPrev();
        }
      } 
      else if(Math.abs(diff) < 10){
        const rect = swipeSurface.getBoundingClientRect();
        const tapX = touchEndX - rect.left;
        const halfWidth = rect.width / 2;
        
        if(tapX < halfWidth){
          goPrev();
        } else {
          goNext();
        }
      }
      
      isSwiping = false;
    });

    coverPage.addEventListener("click", startStory);
    coverPage.addEventListener("touchend", (e) => {
      e.preventDefault();
      startStory();
    });
    
    window.addEventListener("keydown", (e) => {
      if(!storyStarted && (e.key === "Enter" || e.key === " ")){
        e.preventDefault();
        startStory();
      }
    });
  </script>
</body>
</html>